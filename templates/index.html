<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì¶”ì²œ ë ˆì‹œí”¼ ì„ íƒ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .full-summary {
      display: none;
    }
    .btn:disabled {
      opacity: 0.6;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container mt-5">
    <h2 class="mb-4">ğŸ½ ì¶”ì²œ ë ˆì‹œí”¼ ëª©ë¡</h2>
    <form id="option-form" class="mb-5">
      <div class="mb-3">
        <label class="form-label">ì¬ë£Œ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
        <input type="text" class="form-control" id="ingredients" placeholder="ì˜ˆ: beef, onion, tomato" required>
      </div>

      <div class="mb-3">
        <label class="form-label">ì„ í˜¸í•˜ëŠ” ìš”ë¦¬ ìŠ¤íƒ€ì¼</label>
        <input type="text" class="form-control" id="preferred_cuisine" placeholder="e.g., korean, italian, mexican">
      </div>

      <div class="mb-3">
        <label class="form-label">í¬ë§ ì¡°ë¦¬ ì‹œê°„ (ë¶„)</label>
        <input type="number" class="form-control" id="avg_time">
      </div>

      <button type="submit" class="btn btn-primary">5ê°œ ì¶”ì²œ ë³´ê¸°</button>
    </form>

    <div id="search-results-section">
      <h4>ğŸ” searching results</h4>
      <div id="search-results" class="row"></div>
    </div>

    <div id="recommend-section" class="mt-5">
      <h4>ğŸŒŸ recommend recipe indivual</h4>
      <div id="recommend-results" class="row"></div>
    </div>
  </div>

  <script>
    document.getElementById('option-form').addEventListener('submit', async function(e) {
      e.preventDefault();

      const profile = {
        ingredients: document.getElementById('ingredients').value,
        preferred_cuisine: document.getElementById('preferred_cuisine').value,
        avg_time: parseInt(document.getElementById('avg_time').value) || null
      };

      try {
        const response = await fetch('/recommend-options', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(profile)
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const data = await response.json();
        console.log("ì¶”ì²œ ë°›ì€ ë°ì´í„°:", data);
        if (data.error) {
          alert('ì¶”ì²œ ì‹¤íŒ¨: ' + data.error);
          return;
        }
        renderRecipeCards(data);
      } catch (error) {
        console.error('ì¶”ì²œ ìš”ì²­ ì‹¤íŒ¨:', error);
        alert('ì¶”ì²œ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    });

    function renderRecipeCards(recipes) {
      const searchContainer = document.getElementById('search-results');
      const recommendContainer = document.getElementById('recommend-results');

      searchContainer.innerHTML = "";
      recommendContainer.innerHTML = "";

      if (!recipes || recipes.length === 0) {
        searchContainer.innerHTML = '<div class="col-12"><div class="alert alert-info">ì¶”ì²œí•  ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div></div>';
        return;
      }

      window.currentRecipes = recipes;

      recipes.forEach((recipe, index) => {
        const summary = stripHtml(recipe.summary_ko || recipe.summary || "ìš”ì•½ ì—†ìŒ");
        const shortSummary = summary.length > 100 ? summary.slice(0, 100) + "..." : summary;
        const encodedRecipe = encodeURIComponent(JSON.stringify(recipe));

        const card = document.createElement('div');
        card.className = 'col-md-4';

        card.innerHTML = `
          <div class="card mb-4 shadow-sm">
            <img src="${recipe.image || '/static/placeholder.jpg'}" class="card-img-top" alt="${recipe.title}" style="height: 200px; object-fit: cover;">
            <div class="card-body">
              <h5 class="card-title">${recipe.title}</h5>
              <p class="card-text">
                <span id="short-${index}">${shortSummary}</span>
                <span id="full-${index}" style="display: none;">${summary}</span>
              </p>
              ${summary.length > 100 ? `<button class="btn btn-sm btn-secondary mb-2" id="toggle-btn-${index}" onclick="toggleSummary(${index})">ì „ì²´ ë³´ê¸°</button><br>` : ''}
              <button class="btn btn-success" id="save-btn-${index}" onclick='saveSelectedRecipe(${index})'>ì´ ë ˆì‹œí”¼ ì„ íƒ</button>
              ${recipe.id ? `<a href="/recipe-detail?id=${recipe.id}" class="btn btn-outline-secondary mt-2">ì „ì²´ ë ˆì‹œí”¼ ë³´ê¸°</a>` : ''}
            </div>
          </div>
        `;

        if (index < 3) {
          searchContainer.appendChild(card);
        } else {
          recommendContainer.appendChild(card);
        }
      });
    }

    function toggleSummary(index) {
      const shortEl = document.getElementById(`short-${index}`);
      const fullEl = document.getElementById(`full-${index}`);
      const btn = document.getElementById(`toggle-btn-${index}`);

      if (fullEl.style.display === "none") {
        fullEl.style.display = "inline";
        shortEl.style.display = "none";
        btn.textContent = "ê°„ëµíˆ ë³´ê¸°";
      } else {
        fullEl.style.display = "none";
        shortEl.style.display = "inline";
        btn.textContent = "ì „ì²´ ë³´ê¸°";
      }
    }

    async function saveSelectedRecipe(index) {
      if (!window.currentRecipes || !window.currentRecipes[index]) {
        alert('ë ˆì‹œí”¼ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const recipe = window.currentRecipes[index];
      const saveBtn = document.getElementById(`save-btn-${index}`);

      saveBtn.disabled = true;
      saveBtn.textContent = 'ì €ì¥ ì¤‘...';

      console.log("ğŸ“¥ ì„ íƒëœ ë ˆì‹œí”¼:", recipe);

      try {
        const response = await fetch('/save-selection', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ recipe: recipe })
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const data = await response.json();
        if (data.error) {
          alert('ì €ì¥ ì‹¤íŒ¨: ' + data.error);
        } else {
          alert(data.message || "ë ˆì‹œí”¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
          saveBtn.textContent = 'ì €ì¥ ì™„ë£Œ';
          saveBtn.classList.remove('btn-success');
          saveBtn.classList.add('btn-outline-success');
        }
      } catch (error) {
        console.error('ì €ì¥ ìš”ì²­ ì‹¤íŒ¨:', error);
        alert('ë ˆì‹œí”¼ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        saveBtn.disabled = false;
        saveBtn.textContent = 'ì´ ë ˆì‹œí”¼ ì„ íƒ';
      }
    }

    function stripHtml(html) {
      const div = document.createElement("div");
      div.innerHTML = html;
      return div.textContent || div.innerText || "";
    }
  </script>
</body>
</html>
