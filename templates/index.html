<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>추천 레시피 선택</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .full-summary {
      display: none;
    }
    .btn:disabled {
      opacity: 0.6;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container mt-5">
    <h2 class="mb-4">🍽 추천 레시피 목록</h2>
    <form id="option-form" class="mb-5">
      <div class="mb-3">
        <label class="form-label">재료 (쉼표로 구분)</label>
        <input type="text" class="form-control" id="ingredients" placeholder="예: beef, onion, tomato" required>
      </div>

      <div class="mb-3">
        <label class="form-label">선호하는 요리 스타일</label>
        <input type="text" class="form-control" id="preferred_cuisine" placeholder="e.g., korean, italian, mexican">
      </div>

      <div class="mb-3">
        <label class="form-label">희망 조리 시간 (분)</label>
        <input type="number" class="form-control" id="avg_time">
      </div>

      <button type="submit" class="btn btn-primary">5개 추천 보기</button>
    </form>

    <div id="search-results-section">
      <h4>🔍 searching results</h4>
      <div id="search-results" class="row"></div>
    </div>

    <div id="recommend-section" class="mt-5">
      <h4>🌟 recommend recipe indivual</h4>
      <div id="recommend-results" class="row"></div>
    </div>
  </div>

  <script>
    document.getElementById('option-form').addEventListener('submit', async function(e) {
      e.preventDefault();

      const profile = {
        ingredients: document.getElementById('ingredients').value,
        preferred_cuisine: document.getElementById('preferred_cuisine').value,
        avg_time: parseInt(document.getElementById('avg_time').value) || null
      };

      try {
        const response = await fetch('/recommend-options', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(profile)
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const data = await response.json();
        console.log("추천 받은 데이터:", data);
        if (data.error) {
          alert('추천 실패: ' + data.error);
          return;
        }
        renderRecipeCards(data);
      } catch (error) {
        console.error('추천 요청 실패:', error);
        alert('추천 요청에 실패했습니다.');
      }
    });

    function renderRecipeCards(recipes) {
      const searchContainer = document.getElementById('search-results');
      const recommendContainer = document.getElementById('recommend-results');

      searchContainer.innerHTML = "";
      recommendContainer.innerHTML = "";

      if (!recipes || recipes.length === 0) {
        searchContainer.innerHTML = '<div class="col-12"><div class="alert alert-info">추천할 레시피가 없습니다.</div></div>';
        return;
      }

      window.currentRecipes = recipes;

      recipes.forEach((recipe, index) => {
        const summary = stripHtml(recipe.summary_ko || recipe.summary || "요약 없음");
        const shortSummary = summary.length > 100 ? summary.slice(0, 100) + "..." : summary;
        const encodedRecipe = encodeURIComponent(JSON.stringify(recipe));

        const card = document.createElement('div');
        card.className = 'col-md-4';

        card.innerHTML = `
          <div class="card mb-4 shadow-sm">
            <img src="${recipe.image || '/static/placeholder.jpg'}" class="card-img-top" alt="${recipe.title}" style="height: 200px; object-fit: cover;">
            <div class="card-body">
              <h5 class="card-title">${recipe.title}</h5>
              <p class="card-text">
                <span id="short-${index}">${shortSummary}</span>
                <span id="full-${index}" style="display: none;">${summary}</span>
              </p>
              ${summary.length > 100 ? `<button class="btn btn-sm btn-secondary mb-2" id="toggle-btn-${index}" onclick="toggleSummary(${index})">전체 보기</button><br>` : ''}
              <button class="btn btn-success" id="save-btn-${index}" onclick='saveSelectedRecipe(${index})'>이 레시피 선택</button>
              ${recipe.id ? `<a href="/recipe-detail?id=${recipe.id}" class="btn btn-outline-secondary mt-2">전체 레시피 보기</a>` : ''}
            </div>
          </div>
        `;

        if (index < 3) {
          searchContainer.appendChild(card);
        } else {
          recommendContainer.appendChild(card);
        }
      });
    }

    function toggleSummary(index) {
      const shortEl = document.getElementById(`short-${index}`);
      const fullEl = document.getElementById(`full-${index}`);
      const btn = document.getElementById(`toggle-btn-${index}`);

      if (fullEl.style.display === "none") {
        fullEl.style.display = "inline";
        shortEl.style.display = "none";
        btn.textContent = "간략히 보기";
      } else {
        fullEl.style.display = "none";
        shortEl.style.display = "inline";
        btn.textContent = "전체 보기";
      }
    }

    async function saveSelectedRecipe(index) {
      if (!window.currentRecipes || !window.currentRecipes[index]) {
        alert('레시피 데이터를 찾을 수 없습니다.');
        return;
      }

      const recipe = window.currentRecipes[index];
      const saveBtn = document.getElementById(`save-btn-${index}`);

      saveBtn.disabled = true;
      saveBtn.textContent = '저장 중...';

      console.log("📥 선택된 레시피:", recipe);

      try {
        const response = await fetch('/save-selection', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ recipe: recipe })
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const data = await response.json();
        if (data.error) {
          alert('저장 실패: ' + data.error);
        } else {
          alert(data.message || "레시피가 저장되었습니다!");
          saveBtn.textContent = '저장 완료';
          saveBtn.classList.remove('btn-success');
          saveBtn.classList.add('btn-outline-success');
        }
      } catch (error) {
        console.error('저장 요청 실패:', error);
        alert('레시피 저장에 실패했습니다.');
        saveBtn.disabled = false;
        saveBtn.textContent = '이 레시피 선택';
      }
    }

    function stripHtml(html) {
      const div = document.createElement("div");
      div.innerHTML = html;
      return div.textContent || div.innerText || "";
    }
  </script>
</body>
</html>
